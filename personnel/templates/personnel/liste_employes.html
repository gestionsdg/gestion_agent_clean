{% load extra_filters %}

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Liste des Employ√©s</title>

  <!-- ‚úÖ Responsive -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=iYROa-4j9LVNWwPYs1VIAEzkl9oemgm92XPtW82e6fw2eG6Wns_a4Mp3-H8NruO7ODyfpQm4XLeECUGalh7evggWCi0V0TfcI-ka3hAswi4lqUNmLcK4bD26RcG3Yfwff_cezc2oQt9u-_6oTPyAij3lrwxxQGMeiKO88MKPgpH_AOkhRatAsUO2uKeGYa1rUhSUi2rn0Gj8by_VvtYH4sNGrsLuud1NLN2T403sHZ3dolydEN8me5DuUGryvoQomxwOtteG5TiIjlFIFEs9Df_NbMkNXmfeiOEtWu4IHdGJYDIirVx8soZO3bdgBdSKt1aQp1XETc53Gd2dZaykCxPO5SYLanQ8XxsjnQmRJ1ZUrzU4kH4EBU5y5iD8Seu9fo75Ary1kaxCQabaTDvOucKH6bQHz22nad2hF6nrxzSMSbx30wTppwnILmyXhAQ9827IEPyqi7OuUyQAN4xVS4I7WOC4q1e-OgAJiUhJAEbd_zMKlm2u8hY_F_TRx0g0EBXCqTQp1CYNPVuDoYO7FG7BXiuyxN5avhdgFpn2eJ5S-zL75hi2raf691wVNFpQ9Bev4aALHn85ENk5KslBHaRbeJlK3bvmw17Ttw7x24FO5tgBIONrMUc--inac_gHpA6KTr0As32xaIkDaO1zqF31mGlUuJ9j2Y5Uhfo9DNkl8pM9hAl1593coLFV6nsB8Cm9lqP5lnpDv250JoA9AkRFf3UN9lbIalC4KytnBD5xVVAfFFM8eOeO97osEDJZ7kZKp1yBLVyZFqEnvbRagkK4Ob9M9R1OkPU3YIw66ovj470Cro75xK39CF-awpm5--cHa4HIjmmRnX9JFwRnOcTsC6bSCR4_LS-0KMr-6OQ2XXn5BxoEkJnm2HPJz3hCSc86CO3QefNdeG-a2zmABu3qnS6PLBePW-7RuBe4OZUToVU31bURRm1cf7JpuwnYb1tvfGcXk04SbK7lT5fR2jcHqkaxvfauxahQp5zM03UxBrzAweyFOXBK5oxy0S1y4NPhhqk4KHrq4-wpAr-X_NiQNJYoDZHR_MvcKEZMyOvnXHA8dO8S0ffp7geWJfCCOG-s3kOUcENz4xENhxvykApdoGBZwzR1FOjNx4iuhHphsGTed0T1I4i1AiEC82CrDXtD3YOUL9DI0y9DNVEP5x39JDXPeuMUt3ki_u_rEHbcuSGHj1LHp7wof2GNVPFEf8s_pnA5im4c7mF3d0y_UNFRCHTm-lWi6Nt1fcMqibOsiVrfrAwCOHgMus61KGfUJ7m3Ee0ez_YchKi9_tQe-yhOb4tyYEODyj1yQBP7DIIfeoJgbE7AOnl8R6jFHk0yxolDKanE1zfAHxRNgMuabfJ61Nw51CkuFJxuYF_bjc6w33NHeNR3eshM1zRxqP8eYKL81Bvp0H8FUZfMCvhXOe-ZkS8NYezUqI7SK8K2C016dTaxpbSHZOQ--tTnJ6OjhZHwcmup0c0EcsgpOZqEmvO8W4uCesAcpDzijaOWPEm44BzxtktWXtAXfZYB0z0GMk_9--Zk8RXoMTCaju_ERKzCc-i6-juioCgu7TWXnAxzcHfRB1SvP9nuE0928uu2uBvLg2-yo-e1M5OkawjU9PIbHg56t9zkvZ3zn6FE5AfyyxcNbFlnr3qj0L5yCXD0ZlV27jQ8b3TTL1jcXfq9_y7uTytmRTDpcEMelioYCj7Sdm5FJr8HGahacIaUiBGEQV4_CIicRRlmzG5h0doFRmax9I3rfz7gkXrnuIPb_k4" nonce="15ba19504a4bb06b9c9072a3917895c5" charset="UTF-8"></script>

  <style>
    /* ‚Äî‚Äî‚Äî Anti-d√©bordement global ‚Äî‚Äî‚Äî */
    html, body { max-width: 100%; overflow-x: hidden; }

    /* ===== Mise en page g√©n√©rale ===== */
    body {
      font-family: Arial, sans-serif;
      margin: 10px clamp(14px, 4vw, 45px);
      font-size: 13px;
      background: #f8fafc;
    }

    /* ‚úÖ Cadre bleu autour de tout le contenu */
    .page-frame{
      border: 2px solid #0b5ed7;
      border-radius: 10px;
      background: #fff;
      padding: clamp(12px, 2vw, 22px);
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      box-sizing: border-box;
      max-width: 100%;
    }

    h1 {
      text-align: center;
      color: #333;
      font-size: 20px;
      margin-bottom: 10px;
    }

    /* ===== Boutons d‚Äôaction (haut) ===== */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-bottom: 10px;
    }

    .btn-group a button,
    .btn-group form button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 13px;
      cursor: pointer;
    }

    /* ===== Conteneur anti-d√©bordement du tableau ===== */
    .table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ===== Tableau ===== */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      table-layout: fixed;
      min-width: 980px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      word-wrap: break-word;
      overflow-wrap: anywhere;
      font-size: 13px;
    }

    th { background-color: #d0e7f9; text-align: center; }
    td { text-align: left; }

    /* ===== Largeurs par colonne (base desktop) ===== */
    th.col-num,        td.col-num        { width: 40px;  text-align: center; }
    th.col-matricule,  td.col-matricule  { width: 60px;  text-align: center; }
    th.col-sexe,       td.col-sexe       { width: 35px;  text-align: center; }
    th.col-nom,        td.col-nom        { width: 200px; }
    th.col-prenom,     td.col-prenom     { width: 120px; }
    th.col-grade,      td.col-grade      { width: 120px; }
    th.col-fonction,   td.col-fonction   { width: 120px; }
    th.col-service,    td.col-service    { width: 160px; }
    th.col-entite,     td.col-entite     { width: 200px; }
    th.col-statut,     td.col-statut     { width: 90px;  text-align: center; }
    th.col-actions,    td.col-actions    { width: 120px; text-align: center; }

    /* ===== Colonne Actions ===== */
    td.action-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .action-buttons button {
      padding: 4px 6px;
      margin: 0 2px;
      border: none;
      font-size: 12px;
      cursor: pointer;
    }

    /* ‚úÖ Texte blanc et gras pour Modifier & PDF */
    .action-buttons .modifier-btn,
    .action-buttons .pdf-btn {
      color: #fff;
      font-weight: 700;
    }

    /* (tes couleurs de fond) */
    .modifier-btn { background-color: orange; }
    .pdf-btn      { background-color: teal;   }

    /* ===== Pagination ===== */
    .pagination {
      text-align: center;
      margin-top: 15px;
      font-size: 12px;
    }

    .pagination a,
    .pagination span {
      padding: 3px 6px;
      margin: 0 2px;
      border: 1px solid #ccc;
      text-decoration: none;
      color: #333;
    }

    .pagination .current {
      background-color: #333;
      color: #fff;
      font-weight: bold;
    }

    /* ===== Media queries ===== */
    @media (max-width: 1366px) {
      body { margin: 8px clamp(12px, 3vw, 28px); }
      th, td { font-size: 12px; padding: 3px 5px; }
      table { min-width: 1080px; }

      th.col-num,       td.col-num       { width: 38px; }
      th.col-matricule, td.col-matricule { width: 56px; }
      th.col-sexe,      td.col-sexe      { width: 34px; }
      th.col-nom,       td.col-nom       { width: 170px; }
      th.col-prenom,    td.col-prenom    { width: 105px; }
      th.col-grade,     td.col-grade     { width: 100px; }
      th.col-fonction,  td.col-fonction  { width: 100px; }
      th.col-service,   td.col-service   { width: 130px; }
      th.col-entite,    td.col-entite    { width: 165px; }
      th.col-statut,    td.col-statut    { width: 85px; }
      th.col-actions,   td.col-actions   { width: 105px; }
    }

    @media (max-width: 1200px) {
      th, td { font-size: 11.5px; padding: 3px 4px; }
      table { min-width: 960px; }
    }

    @media (max-width: 992px) {
      th, td { font-size: 11px; padding: 3px 3px; }
      table { min-width: 860px; }
      .action-buttons button { padding: 3px 5px; font-size: 11px; }
    }
  </style>
</head>

<body>
  <div class="page-frame">
    <h1 style="text-decoration: underline;">Liste des Agents de la CNSS</h1>

    {# ==== Pr√©-r√©solution des URLs ==== #}
    {% url 'personnel:ajouter_employe' as ajouter_employe_ns %}{% url 'ajouter_employe' as ajouter_employe_plain %}
    {% url 'personnel:liste_actifs_par_entite' as liste_actifs_par_entite_ns %}{% url 'liste_actifs_par_entite' as liste_actifs_par_entite_plain %}
    {% url 'personnel:liste_retraitables_pdf' as retraitables_ns %}{% url 'liste_retraitables_pdf' as retraitables_plain %}

    {# ‚úÖ NOUVEAU : Page HTML interactive Retraitables #}
    {% url 'personnel:liste_retraitables_page' as retraitables_page_ns %}
    {% url 'liste_retraitables_page' as retraitables_page_plain %}

    {% url 'personnel:liste_responsables_coordonnateurs' as resp_coord_ns %}{% url 'liste_responsables_coordonnateurs' as resp_coord_plain %}
    {% url 'personnel:liste_controleurs' as controleurs_ns %}{% url 'liste_controleurs' as controleurs_plain %}
    {% url 'personnel:export_employes_excel_complet' as export_excel_ns %}{% url 'export_employes_excel_complet' as export_excel_plain %}
    {% url 'personnel:effectif_detaille_par_grade' as effectif_grade_ns %}{% url 'effectif_detaille_par_grade' as effectif_grade_plain %}
    {% url 'personnel:liste_effectif_par_entite_pdf' as eff_entite_pdf_ns %}{% url 'liste_effectif_par_entite_pdf' as eff_entite_pdf_plain %}
    {# ‚úÖ Bouton : Actifs par grade (vue) #}
    {% url 'personnel:effectif_actifs_par_grade' as effet_actifs_grade_ns %}{% url 'effectif_actifs_par_grade' as effet_actifs_grade_plain %}
    {% url 'admin:index' as admin_index_url %}
    {% url 'dashboard' as dashboard_url %}{% url 'personnel:dashboard' as dashboard_ns %}
    {% url 'logout' as logout_url %}{% url 'personnel:logout' as logout_ns %}

    {# ‚úÖ NOUVEAU : Liste Actifs filtr√©e (HTML) #}
    {% url 'personnel:liste_actifs_filtre' as actifs_filtre_ns %}{% url 'liste_actifs_filtre' as actifs_filtre_plain %}

    {# ‚úÖ NOUVEAU : Liste Niveau d‚Äô√©tudes / option / adresse (HTML) #}
    {% url 'personnel:liste_niveau_etudes_option_adresse' as niv_opt_addr_page_ns %}
    {% url 'liste_niveau_etudes_option_adresse' as niv_opt_addr_page_plain %}

    {# ‚úÖ NOUVEAU : PDF Niveau d‚Äô√©tudes / option / adresse #}
    {% url 'personnel:liste_niveau_etudes_option_adresse_pdf' as niv_opt_addr_ns %}
    {% url 'liste_niveau_etudes_option_adresse_pdf' as niv_opt_addr_plain %}

    <!-- ===== Boutons principaux (haut de page) ===== -->
    <div class="btn-group">
      {% if perms.personnel.add_employe %}
        {% with ajouter_employe_url=ajouter_employe_ns|default:ajouter_employe_plain %}
          {% if ajouter_employe_url %}
            <a href="{{ ajouter_employe_url }}">
              <button style="background-color: green;">+ Ajouter un employ√©</button>
            </a>
          {% endif %}
        {% endwith %}
      {% endif %}

      <a href="{{ liste_actifs_par_entite_ns|default:liste_actifs_par_entite_plain }}">
        <button style="background-color: #007bff;">üìÑ Cadres et Agents actifs</button>
      </a>

      {# ‚úÖ Nouveau bouton : liste filtr√©e des Actifs #}
      <a href="{{ actifs_filtre_ns|default:actifs_filtre_plain }}{% if entite or grade %}?{% if entite %}entite={{ entite|urlencode }}{% endif %}{% if entite and grade %}&{% endif %}{% if grade %}grade={{ grade|urlencode }}{% endif %}{% endif %}">
        <button style="background-color: #0d6efd;">üßæ Actifs (liste filtr√©e)</button>
      </a>

      {# ‚úÖ Nouveau bouton : page interactive Retraitables (filtrer & imprimer) #}
      <a href="{{ retraitables_page_ns|default:retraitables_page_plain }}">
        <button style="background-color: #1F497D; color: white;">üñ®Ô∏è Retraitables (filtrer & imprimer)</button>
      </a>

      {# Bouton historique : PDF direct Retraitables #}
      <a href="{{ retraitables_ns|default:retraitables_plain }}" target="_blank">
        <button style="background-color: #d9534f; color: white;">üìÑ Cadres et Agents retraitables</button>
      </a>

      <a href="{% firstof resp_coord_ns resp_coord_plain %}{% if entite %}?entite={{ entite|urlencode }}{% endif %}">
        <button style="background-color: #20B2AA;">üñåÔ∏è Responsables de Service</button>
      </a>

      <a href="{{ controleurs_ns|default:controleurs_plain }}">
        <button style="background-color: navy;">üìã Contr√¥leurs</button>
      </a>

      {% if request.user.is_superuser %}
        <a href="{{ export_excel_ns|default:export_excel_plain }}">
          <button style="background-color: purple;">üì§ Exporter Excel</button>
        </a>
      {% endif %}
    </div>

    <div class="btn-group">
      <a href="{{ effectif_grade_ns|default:effectif_grade_plain }}">
        <button style="background-color: #17a2b8; color: white;">üìä Effectif Agents par grade et entit√©</button>
      </a>

      <a href="{{ eff_entite_pdf_ns|default:eff_entite_pdf_plain }}" target="_blank">
        <button style="background-color: #6c757d; color: white;">üìä Effectif Agents par entit√©</button>
      </a>

      <a href="{{ effet_actifs_grade_ns|default:effet_actifs_grade_plain }}">
        <button style="background-color: #0b7285; color: white;">üìä Effectif Agents par grade</button>
      </a>

      {# ‚úÖ BOUTON UNIQUE : HTML Niveau d‚Äô√©tudes / option / adresses (page) #}
      <a href="{{ niv_opt_addr_page_ns|default:niv_opt_addr_page_plain }}{% if entite %}?entite={{ entite|urlencode }}{% endif %}">
        <button style="background-color: #198754; color: white;">
          üéì Niveaux d'√©tudes / options / adresses (page)
        </button>
      </a>

      {% if request.user.is_superuser and admin_index_url %}
        <a href="{{ admin_index_url }}">
          <button style="background-color: #000000;">üîô Retour √† l'administration</button>
        </a>
      {% endif %}

      <a href="{{ dashboard_ns|default:dashboard_url|default:'/dashboard/' }}">
        <button style="background-color: #888;">‚¨Ö Retour au tableau de bord</button>
      </a>

      <a href="{{ logout_ns|default:logout_url|default:'/logout/' }}">
        <button style="background-color: darkred;">üîí Quitter</button>
      </a>
    </div>

    <!-- ===== Filtres ===== -->
    <form method="get" class="form-filtres" style="text-align:center; margin:15px 0;">
      <input type="text" name="q" placeholder="Rechercher nom, pr√©nom, matricule" value="{{ query }}">

      <select name="grade">
        <option value="">-- Grade actuel --</option>
        {% for g in grades %}
          <option value="{{ g }}" {% if grade == g %}selected{% endif %}>{{ g }}</option>
        {% endfor %}
      </select>

      <select name="entite">
        <option value="">-- Entit√© --</option>
        {% for e in entites %}
          <option value="{{ e }}" {% if entite == e %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>

      <select name="statut">
        <option value="">-- Statut --</option>
        {% for s in statuts %}
          <option value="{{ s }}" {% if statut == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>

      <button type="submit">Rechercher</button>
    </form>

    <!-- ‚úÖ Conteneur anti-d√©bordement -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="col-num">N¬∞</th>
            <th class="col-nom">Nom</th>
            <th class="col-prenom">Pr√©nom</th>
            <th class="col-matricule">Matricule</th>
            <th class="col-grade">Grade actuel</th>
            <th class="col-sexe">Sexe</th>
            <th class="col-service">Service</th>
            <th class="col-fonction">Fonction</th>
            <th class="col-statut">Statut</th>
            <th class="col-entite">Entit√©</th>
            <th class="col-actions">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for emp in page_obj %}
            <tr>
              <td class="col-num">{{ forloop.counter0|add:page_obj.start_index }}</td>
              <td class="col-nom">{{ emp.nom|clean_nan }}</td>
              <td class="col-prenom">{{ emp.prenom|clean_nan }}</td>
              <td class="col-matricule">{{ emp.matricule|clean_nan }}</td>
              <td class="col-grade">{{ emp.grade_actuel|clean_nan }}</td>
              <td class="col-sexe">{{ emp.sexe|clean_nan }}</td>
              <td class="col-service">{{ emp.service|clean_nan }}</td>
              <td class="col-fonction">{{ emp.fonction|clean_nan }}</td>
              <td class="col-statut">{{ emp.statut|clean_nan }}</td>
              <td class="col-entite">{{ emp.entite|clean_nan }}</td>
              <td class="action-buttons col-actions">
                {% url 'personnel:modifier_employe' emp.id as mod_ns %}{% url 'modifier_employe' emp.id as mod_plain %}
                {% url 'personnel:fiche_employe_pdf' emp.id as fiche_ns %}{% url 'fiche_employe_pdf' emp.id as fiche_plain %}

                {% with mod_url=mod_ns|default:mod_plain %}
                  {% if perms.personnel.change_employe and mod_url %}
                    <a href="{{ mod_url }}">
                      <button class="modifier-btn" style="background-color:orange;">Modifier</button>
                    </a>
                  {% endif %}
                {% endwith %}

                <a href="{{ fiche_ns|default:fiche_plain }}" target="_blank">
                  <button class="pdf-btn" style="background-color:teal;">PDF</button>
                </a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="11" style="text-align: center;">Aucun r√©sultat trouv√©.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ===== Pagination ===== -->
    <div class="pagination">
      {% if page_obj.has_previous %}
        <a href="?page=1">¬´ premi√®re</a>
        <a href="?page={{ page_obj.previous_page_number }}">‚Äπ pr√©c√©dente</a>
      {% endif %}

      <span class="current">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">suivante ‚Ä∫</a>
        <a href="?page={{ page_obj.paginator.num_pages }}">derni√®re ¬ª</a>
      {% endif %}
    </div>
  </div>
</body>
</html>
