{% extends 'base.html' %}
{% block content %}
<style>
  @media print {
    form, .noprint {
      display: none;
    }
  }

  h2 {
    text-align: center;
    text-decoration: underline;
    margin-bottom: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  th, td {
    border: 1px solid #333;
    padding: 4px;
    text-align: center;
  }

  th.left, td.left {
    text-align: left;
  }

  th {
    background-color: #f2f2f2;
  }

  .bg-fonction { background-color: #cce5ff; } /* bleu ciel */
  .bg-grade   { background-color: #d4edda; } /* vert clair */

  /* ✅ Footer : caché à l'écran, visible à l'impression */
  .footer-impression { display: none; }
  @media print {
    .footer-impression { display: block; }
    body { padding-bottom: 60px !important; } /* espace pour le footer fixé */
  }
</style>

{# URL retour robuste (namespacée puis fallback) #}
{% url 'personnel:liste_employes' as liste_employes_ns %}{% url 'liste_employes' as liste_employes_plain %}

<h2>{{ titre }}</h2>

{# Formulaire visible à l'écran uniquement, et seulement si la liste "entites" est fournie #}
{% if entites %}
<form method="get" class="noprint">
  <label for="entite">Filtrer par entité :</label>
  {% with current=selected_entite|default:entite|default:request.GET.entite %}
    <select name="entite" id="entite" onchange="this.form.submit()">
      <option value="">-- Toutes les entités --</option>
      {% for ent in entites %}
        {% if ent %}
          <option value="{{ ent }}" {% if current == ent %}selected{% endif %}>{{ ent }}</option>
        {% endif %}
      {% endfor %}
    </select>
  {% endwith %}
</form>
{% endif %}

<table>
  <thead>
    <tr>
      {% for col in colonnes %}
        <th>{{ col }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {# "donnees" = [N°, Nom, Matricule, Grade, Sexe, Service, Fonction, Date affectation, Durée] #}
    {% for ligne in donnees %}
      {% with fonction=ligne.6 grade=ligne.3 %}
        <tr class="{% if fonction == 'Responsable a.i' or fonction == 'Coordonnateur a.i' %}bg-fonction{% elif grade == 'Chef de Sce Adjt' or grade == 'Chef de Section' or grade == 'Rédacteur Ppal' or grade == 'Rédacteur' %}bg-grade{% endif %}">
          {% for val in ligne %}
            {# Colonnes alignées à gauche: Nom(1), Grade(3), Service(5), Fonction(6) #}
            {% if forloop.counter0 == 1 or forloop.counter0 == 3 or forloop.counter0 == 5 or forloop.counter0 == 6 %}
              <td class="left">{{ val|default:"-" }}</td>
            {% else %}
              <td>{{ val|default:"-" }}</td>
            {% endif %}
          {% endfor %}
        </tr>
      {% endwith %}
    {% empty %}
      <tr>
        <td colspan="{{ colonnes|length }}">Aucun résultat</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<div class="noprint" style="margin-top: 10px;">
  <a href="{{ liste_employes_ns|default:liste_employes_plain|default:'/employes/' }}">← Retour à la liste des employés</a>
</div>

<!-- ✅ Footer réutilisable, seulement à l'impression -->
{% include "personnel/_footer_impression.html" %}
{% endblock %}
