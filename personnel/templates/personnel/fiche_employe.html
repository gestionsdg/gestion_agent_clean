{% load extra_filters %}
{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fiche de l'employ√©</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px 15px; }
        h2, h3 { text-align: center; }
        /* Titre soulign√© (impression/PDF inclus) */
        h3 { text-decoration: underline; }

        .photo-container { text-align: center; margin-bottom: 20px; }
        .photo-container img {
            max-height: 180px;
            max-width: 100%;
            border: 1px solid #ccc;
            padding: 4px;
            object-fit: cover;
            border-radius: 6px;
        }
        /* Encadr√© ‚ÄúIns√©rer la photo‚Äù */
        .no-photo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 180px;
            width: 180px;
            max-width: 100%;
            border: 2px dashed #bbb;
            color: #777;
            font-weight: 600;
            border-radius: 6px;
            background: #fafafa;
        }

        .btn-imprimer { text-align: right; margin-bottom: 10px; }
        .btn-imprimer button {
            padding: 6px 12px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        td, th { padding: 8px; border: 1px solid #ccc; text-align: left; vertical-align: top; word-wrap: break-word; }
        .pre-lines { white-space: pre-line; } /* Affiche les retours √† la ligne du texte brut */
        @media print { .btn-imprimer { display: none; } }
    </style>
</head>
<body>
    <h3>
        Fiche individuelle de l'agent
        {{ employe.nom|default_if_none:""|clean_nan|default:"-" }}
        {% with rawp=employe.prenom|default_if_none:""|clean_nan %}
            {% if rawp %}
                {% with p=rawp|lower %}
                    {% if p != 'inconnu' and p != 'none' and p != 'nan' %}
                        {{ rawp }}
                    {% endif %}
                {% endwith %}
            {% endif %}
        {% endwith %}
    </h3>

    <div class="btn-imprimer">
        <button onclick="window.print()">üñ®Ô∏è Imprimer cette fiche</button>
    </div>

    <div class="photo-container">
        {# 1) Cas PDF (WeasyPrint) : image en base64 inject√©e par la vue #}
        {% if photo_url_for_pdf %}
            <img src="{{ photo_url_for_pdf }}" alt="Photo de l'agent">
        {# 2) Cas HTML normal : URL media ; si √©chec ‚Üí afficher ‚ÄúIns√©rer la photo‚Äù #}
        {% elif employe.photo %}
            <img src="{{ employe.photo.url }}"
                 alt="Photo de l'agent"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-flex';">
            <div class="no-photo" style="display:none" role="img" aria-label="Aucune photo">Ins√©rer la photo</div>
        {# 3) Pas de photo du tout : afficher ‚ÄúIns√©rer la photo‚Äù #}
        {% else %}
            <div class="no-photo" role="img" aria-label="Aucune photo">Ins√©rer la photo</div>
        {% endif %}
    </div>

    <table>
        <tr><th>Entit√©</th><td>{{ employe.entite|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Matricule</th><td>{{ employe.matricule|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Sexe</th><td>{{ employe.sexe|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>√âtat civil</th><td>{{ employe.etat_civil|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Nom du (de la) conjoint(e)</th><td>{{ employe.nom_conjoint|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Grade d'engagement</th><td>{{ employe.grade_engagement|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Date d'engagement</th><td>{{ employe.date_engagement|date:'d/m/Y'|default:"-" }}</td></tr>
        <tr><th>Anciennet√© √† la CNSS</th><td>{{ anciennete_societe|clean_nan|default:"-" }}</td></tr>
        <tr><th>Date de naissance</th><td>{{ employe.date_naissance|date:'d/m/Y'|default:"-" }}</td></tr>
        <tr><th>√Çge</th><td>{{ age|clean_nan|default:"-" }}</td></tr>
        <tr><th>Grade actuel</th><td>{{ employe.grade_actuel|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Date derni√®re promotion</th><td>{{ employe.date_derniere_promotion|date:'d/m/Y'|default:"-" }}</td></tr>
        <tr><th>Anciennet√© dans le grade</th><td>{{ anciennete_grade|clean_nan|default:"-" }}</td></tr>
        <tr><th>Service</th><td>{{ employe.service|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Date d'affectation</th><td>{{ employe.date_affectation|date:'d/m/Y'|default:"-" }}</td></tr>
        <tr><th>Dur√©e d‚Äôaffectation</th><td>{{ duree_affectation|clean_nan|default:"-" }}</td></tr>
        <tr><th>Fonction</th><td>{{ employe.fonction|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Date prise de fonction</th><td>{{ employe.date_prise_fonction|date:'d/m/Y'|default:"-" }}</td></tr>
        <tr><th>Dur√©e prise de fonction</th><td>{{ duree_prise_fonction|clean_nan|default:"-" }}</td></tr>
        <tr><th>Niveau d'√©tudes</th><td>{{ employe.niveau_etudes|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Option</th><td>{{ employe.option|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>Adresse</th><td>{{ employe.adresse|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>T√©l√©phone 1</th><td>{{ employe.telephone1|default_if_none:""|clean_nan|default:"-" }}</td></tr>
        <tr><th>T√©l√©phone 2</th><td>{{ employe.telephone2|default_if_none:""|clean_nan|default:"-" }}</td></tr>

        <!-- Textes multi-lignes : afficher "-" si vide/None/nan -->
        <tr>
            <th>Parcours professionnel</th>
            <td class="pre-lines">
                {% with t=employe.parcours_professionnel|default_if_none:""|clean_nan %}
                    {% if t %}{{ t }}{% else %}-{% endif %}
                {% endwith %}
            </td>
        </tr>
        <tr>
            <th>Formations suivies</th>
            <td class="pre-lines">
                {% with t=employe.formations_suivies|default_if_none:""|clean_nan %}
                    {% if t %}{{ t }}{% else %}-{% endif %}
                {% endwith %}
            </td>
        </tr>
        <tr>
            <th>Besoin en formation</th>
            <td class="pre-lines">
                {% with t=employe.besoin_en_formation|default_if_none:""|clean_nan %}
                    {% if t %}{{ t }}{% else %}-{% endif %}
                {% endwith %}
            </td>
        </tr>

        <tr><th>Statut</th><td>{{ employe.statut|default_if_none:""|clean_nan|default:"-" }}</td></tr>
    </table>

    <p style="text-align: right; margin-top: 20px;">
        <em>Fiche imprim√©e le : {{ date_impression|default:"" }}</em>
    </p>
</body>
</html>
